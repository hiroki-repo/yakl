//#include "hsp3cl.as"
//#include "hsp3gp.as"
#runtime "hsp3hg"
#packopt hide 1

/*

HSP??R?[???o?b?N???W???[??
HSP3.5 beta 3?????m?F
?p?u???b?N?h???C?????
CC0 1.0????C?Z???X?????(CC0??R?????Y?????? http://creativecommons.org/publicdomain/zero/1.0/deed.ja)


?R?[???o?b?N??????
makeclbkfunc p1,p2,3,p4
p1=?????              ?R?[???o?b?N??????K?v??????n???????|?C???^(?T?u???[?`???????R?[???o?b?N??????|?C???^)????????
p2=0~(0)               ?n????????????? (p2<=0???????????????)
p3=???x????            ?R?[???o?b?N????????????T?u???[?`??????x??
p4=0|1(0)              ??„‘o???K????? 0=stdcall 1=cdecl   p4??????????stdcall??????

??????????????? (p2<=0) ??A??„‘o?????? lparam=NULL?A wparam=0 ??????
????????????     (p2>0)  ??A??„‘o?????? lparam=???????o?b?t?@?A?h???X?A wparam=?????????? ??????
?????????????m??G???[??? ??A??„‘o?????? lparam=NULL?A wparam=0 ??????

?T?u???[?`???????????????? stat ????l???R?[???o?b?N????????l??????

?????o?b?t?@??T?u???[?`?????????????????? (lparam?Awparam??l??ƒÏE???????)
argclbkfunc ??????????ï??????A?????????????K?v??????Awparam?Alparam??l??j????????????


lparam??wparam????????????ï
argclbkfunc p1
p1=?z??              ?????????ï???????^?z??

?????????????^?z?????? p1 ?????????? (?????o?b?t?@????R?s?[??????)
?R?[???o?b?N????????????T?u???[?`??????g?p???????????
wparam ?? lparam ???ï?O??j???????????????„‘o?????????g?p???????????
lparam ?? wparam ??`?F?b?N??s???????

*/




//???W???[??
//-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|//
#ifndef _modulemakeclbkfuncah_def_
#define _modulemakeclbkfuncah_def_
#module

	#uselib "kernel32.dll"
	#func VirtualProtect "VirtualProtect" sptr,int,int,var

	#const  FUNCSIZE     22         //?}?V????????
	#const  FUNCSIZEBYT  FUNCSIZE*4 //?}?V????????(?o?C?g)

	#const  PAGE_EXECUTE_READWRITE  $00000040

	#deffunc makeclbkfunc var p_bin, int numargs, label label_sub, int clmode,\
	local hspctx,\
	local int_numargs,\
	local lbl_tmp,\
	local int_tmp,\
	local bin,\
	local int_stat

		lbl_tmp = label_sub  //?T?u???[?`?????x??
		mref hspctx,68
		int_numargs = numargs & $80003FFF
		int_stat=stat        //stat????

		//?e?[?u??????????m??
		static_arr_str_bin(static_int_idx) = "" // ????? / ?v?f???
		memexpand static_arr_str_bin(static_int_idx), FUNCSIZEBYT
		p_bin = varptr(static_arr_str_bin(static_int_idx))

		//?}?V????
		dupptr bin, p_bin, FUNCSIZEBYT
		bin(0)  = $BE56C031       , varptr(hspctx(9)), $B9044689, int_numargs , $8D530689
		bin(5)  = $0000989E       , $7EC98500        , $E1C1511C, $13FF5102   , $04468959
		bin(10) = $74C08559       , $FF0E890C        , $8F088C74, $E2FC8844   , $68C689F6
		bin(15) = lpeek(lbl_tmp,0), $581C53FF        , $0574F685, $0453ff56   , $54838B58
		bin(20) = $5B000002       , $0000C35E
		if clmode==0 & int_numargs>0{
			bin(FUNCSIZE-1) = $C25E | int_numargs << 18  //stdcall????????????????X?^?b?N????
		}

		static_int_idx++
		VirtualProtect p_bin, FUNCSIZEBYT, PAGE_EXECUTE_READWRITE, int_tmp
		return int_stat


	#deffunc argclbkfunc array arr_int_args,\
	local cln_arr_int_tmp

		dupptr cln_arr_int_tmp, lparam, wparam*4
		dim arr_int_args, wparam
		memcpy arr_int_args, cln_arr_int_tmp, wparam*4
		return

#global

#endif

makeclbkfunc clbk, 1, *execapp,1

#include "user32.as"
#packopt orgpath 0
#uselib "user32.dll"
#func DisableProcessWindowsGhosting "DisableProcessWindowsGhosting"
#uselib "kernel32.dll"
#cfunc GetCommandLineA "GetCommandLineA"
#func CreateThread "CreateThread" int,int,int,int,int,int
#func VirtualProtect "VirtualProtect" int,int,int,int
#func GetEnvironmentVariable "GetEnvironmentVariableA" sptr,sptr,int
DisableProcessWindowsGhosting
#uselib "ULDllLoader.dll"
#cfunc ULLoadLibraryA "ULLoadLibraryA" sptr
#func execprogram "execprogram***" int,int,int,int
#func prematexer "execprogram***" int
sdim gamepath,4096
GetEnvironmentVariable "TH06_PATH",gamepath,varsize(gamepath)
if stat==0{
	gamepath="C:\\Program Files\\“Œ•ûg–‚‹½"
}
/*
mov eax,[esp + 4]
push [eax + 16]
push [eax + 12]
push [eax + 8]
push [eax + 4]
call [eax + 0]
add esp, 16
ret
*/
prematex=0x0424448B,0xFF1070FF,0x70FF0C70,0x0470FF08,0xC48310FF,0x0004C210
VirtualProtect varptr(prematex),24,0x40,varptr(tmp)
dupptr execprogramx,libptr(execprogram),28,4
dupptr prematexerx,libptr(prematexer),28,4
peheaderptr=ULLoadLibraryA(gamepath+"\\"+"“Œ•ûg–‚‹½.exe")
dupptr peheader,peheaderptr,4096,2
entrypoint=lpeek(peheader,0x28)+peheaderptr
lpoke execprogramx,0x18,entrypoint
sdim msg,64
lpoke prematexerx,0x18,varptr(prematex)

chdir gamepath
//dim param,4
//param=peheaderptr,0,GetCommandLineA(),1
//CreateThread 0, 0, clbk, hwnd, 0, 0
param=entrypoint,peheaderptr,0,GetCommandLineA(),1
//execprogram peheaderptr,0,GetCommandLineA(),1
//prematexer varptr(param)
CreateThread 0, 0, varptr(prematex), varptr(param), 0, 0
repeat
/*GetMessage msg,0,0,0
if (stat!=0){
DefWindowProcA lpeek(msg,4*0),lpeek(msg,4*1),lpeek(msg,4*2),lpeek(msg,4*3)
}*/
await 1
loop
end
stop
*execapp
argclbkfunc argv
execprogram peheaderptr,0,GetCommandLineA(),1
return 0
//return callfunc(param,entrypoint,4)
